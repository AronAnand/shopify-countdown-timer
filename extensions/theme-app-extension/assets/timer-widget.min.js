!function(){"use strict";const{h:t,render:n,Component:e}=window.preact||function(){const t=(n,e)=>{if(!n)return;if("string"==typeof n||"number"==typeof n)return void(e.textContent=n);const o=document.createElement(n.type);for(const[t,e]of Object.entries(n.props||{}))"children"!==t&&("style"===t&&"object"==typeof e?Object.assign(o.style,e):t.startsWith("on")?o.addEventListener(t.slice(2).toLowerCase(),e):o.setAttribute(t,e));const s=n.props?.children||[];for(const n of[].concat(s))if(n){const e=document.createElement("span");t(n,e),o.appendChild(e.firstChild||e)}e.innerHTML="",e.appendChild(o)};return{h:(t,n,...e)=>({type:t,props:{...n,children:e}}),render:t,Component:class{constructor(t){this.props=t,this.state={}}setState(t){this.state={...this.state,..."function"==typeof t?t(this.state):t},this.t()}t(){this.o&&t(this.render(),this.o)}}}}(),o=t=>`countdown_timer_${t}`,s=t=>String(t).padStart(2,"0");class i{constructor(t,n){this.container=t,this.config=n,this.timer=null,this.intervalId=null,this.impressionSent=!1,this.init()}async init(){try{await this.fetchTimer(),this.timer&&(this.render(),this.startCountdown(),this.trackImpression())}catch(t){}}async fetchTimer(){const{shop:t,productId:n,collectionIds:e,apiUrl:o}=this.config,s=new URLSearchParams({shop:t});n&&s.append("productId",n),e&&s.append("collectionIds",e);const i=`${o}/api/storefront/timer?${s}`;try{const t=await fetch(i,{method:"GET",headers:{Accept:"application/json"},cache:"default"});if(!t.ok){if(404===t.status)return;throw new Error(`HTTP ${t.status}`)}const n=await t.json();n.success&&n.data&&(this.timer=n.data,this.setupTimerEndpoint())}catch(t){}}setupTimerEndpoint(){const t=this.timer;if("fixed"===t.type)this.endTime=new Date(t.endDate).getTime();else if("evergreen"===t.type){const n=o(t.id);let e;try{const o=localStorage.getItem(n);if(o){e=parseInt(o,10);Date.now()-e>=60*t.durationMinutes*1e3&&(localStorage.removeItem(n),e=Date.now(),localStorage.setItem(n,String(e)))}else e=Date.now(),localStorage.setItem(n,String(e))}catch(t){e=Date.now()}this.endTime=e+60*t.durationMinutes*1e3}}startCountdown(){this.updateCountdown(),this.intervalId=setInterval(()=>this.updateCountdown(),1e3)}updateCountdown(){const t=(t=>{if(t<=0)return{hours:0,minutes:0,seconds:0,expired:!0};const n=Math.floor(t/1e3);return{hours:Math.floor(n/3600),minutes:Math.floor(n%3600/60),seconds:n%60,expired:!1}})(this.endTime-Date.now());if(t.expired)return void this.handleExpired();const n=this.container.querySelector(".countdown-time");n&&(n.textContent=`${s(t.hours)}:${s(t.minutes)}:${s(t.seconds)}`)}handleExpired(){if(this.intervalId&&(clearInterval(this.intervalId),this.intervalId=null),"evergreen"===this.timer.type){const t=o(this.timer.id);try{localStorage.removeItem(t)}catch(t){}setTimeout(()=>{this.setupTimerEndpoint(),this.startCountdown()},100)}else this.container.style.display="none"}async trackImpression(){this.impressionSent||setTimeout(async()=>{if(this.impressionSent)return;this.impressionSent=!0;const{apiUrl:t,shop:n}=this.config;try{await fetch(`${t}/api/storefront/timer/${this.timer.id}/impression`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({shop:n})})}catch(t){}},2e3)}render(){const t=this.timer.appearance||{},n=`\n      <div class="countdown-widget" style="\n        background-color: ${t.backgroundColor||"#000000"};\n        color: ${t.textColor||"#FFFFFF"};\n        padding: 16px;\n        border-radiusor: 8px;\n        text-align: center;\n        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n        margin: 16px 0;\n        box-sizing: border-box;\n      ">\n        ${t.headline?`\n          <div class="countdown-headline" style="\n            font-size: 14px;\n            font-weight: 600;\n            margin-bottom: 8px;\n            letter-spacing: 0.5px;\n          ">${this.escapeHtml(t.headline)}</div>\n        `:""}\n        \n        <div class="countdown-time" style="\n          font-size: 32px;\n          font-weight: 700;\n          font-variant-numeric: tabular-nums;\n          font-family: 'SF Mono', SFMono-Regular, Consolas, 'Liberation Mono', monospace;\n          letter-spacing: 2px;\n        ">00:00:00</div>\n        \n        ${t.supportingText?`\n          <div class="countdown-supporting" style="\n            font-size: 12px;\n            margin-top: 8px;\n            opacity: 0.85;\n          ">${this.escapeHtml(t.supportingText)}</div>\n        `:""}\n      </div>\n    `;this.container.innerHTML=n}escapeHtml(t){const n=document.createElement("div");return n.textContent=t,n.innerHTML}destroy(){this.intervalId&&(clearInterval(this.intervalId),this.intervalId=null),this.container.innerHTML=""}}!function(){const t=document.querySelectorAll("[data-countdown-timer]");0!==t.length&&t.forEach(t=>{const n={shop:t.dataset.shop,productId:t.dataset.productId,collectionIds:t.dataset.collectionIds,apiUrl:t.dataset.apiUrl||""};n.shop&&new i(t,n)})}(),"undefined"!=typeof window&&(window.CountdownTimer=i)}();
